<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import './block-editor.js';
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"></script>
    <script>
        // Wiederverwendbare Modal-Helper-Funktionen
        // Initialisiere sofort, nicht erst bei alpine:init
        window.modalHelpers = {
            openModal() {
                if (document.body) {
                    document.body.style.overflow = 'hidden';
                }
            },
            closeModal() {
                if (document.body) {
                    document.body.style.overflow = '';
                }
            }
        };

        // Aktualisiere auch bei alpine:init (falls nötig)
        document.addEventListener('alpine:init', () => {
            if (!window.modalHelpers) {
                window.modalHelpers = {
                    openModal() {
                        if (document.body) {
                            document.body.style.overflow = 'hidden';
                        }
                    },
                    closeModal() {
                        if (document.body) {
                            document.body.style.overflow = '';
                        }
                    }
                };
            }
        });
    </script>
    <style>
        [contenteditable="true"]:focus {
            outline: none;
        }

        .block-placeholder:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }

        .block-item[draggable="true"]:hover {
            cursor: move;
        }

        .block-item.drag-over {
            border-top: 2px solid #3b82f6;
            margin-top: 4px;
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div x-data="blockEditor()" x-init="init()" class="flex h-screen overflow-hidden">
        <!-- Notification Component (aus Template) -->
        <div x-html="templates?.notification || ''"></div>



        <!-- Sidebar (aus Template) -->
        <div x-html="templates?.sidebar || ''"></div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto transition-all duration-300">
        <div class="max-w-4xl mx-auto py-8 px-4">
            <!-- Header -->
            <div class="mb-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Block Editor</h1>
                <div class="flex gap-2">
                    <button @click="openSidebar()"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2"
                        title="Einstellungen öffnen">
                        ⚙ Einstellungen
                    </button>
                    <button @click="saveToJSON()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Speichern
                    </button>
                    <button @click="exportJSON()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        JSON Export
                    </button>
                    <button @click="importJSON()"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        JSON Import
                    </button>
                </div>
            </div>

            <!-- Editor Container -->
            <div class="bg-white rounded-lg shadow-lg p-6 min-h-[600px]">
                <!-- Toolbar für neuen Block (aus Template) -->
                <div x-html="templates?.blockToolbar || ''"></div>

                <!-- Blocks Container -->
                <div class="space-y-2">
                    <template x-for="(block, index) in blocks" :key="block.id">
                        <!-- Render Block with Children -->
                        <div>
                            <!-- Main Block -->
                            <div :class="{
                            'ring-2 ring-blue-500': selectedBlockId === block.id,
                            'opacity-50': draggingBlockId === block.id,
                            'drag-over': dragOverIndex && dragOverIndex.type === 'main' && dragOverIndex.index === index && (!dragStartIndex || dragStartIndex.index !== index)
                        }" class="block-item group relative p-2 rounded-lg hover:bg-gray-50 transition-all cursor-move"
                                @click.stop="selectBlock(block.id)" draggable="true"
                                @dragstart="handleDragStart($event, index)"
                                @dragover.prevent="handleDragOver($event, index)" @drop="handleDrop($event, index)"
                                @dragend="handleDragEnd()" @dragleave="dragOverIndex = null">
                                <!-- Visual Indicator für ausgewählten Block -->
                                <div x-show="selectedBlockId === block.id"
                                    class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l"></div>
                                <!-- Block Controls -->
                                <div :class="selectedBlockId === block.id ? 'opacity-100' : ''"
                                    class="absolute -left-10 top-2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    <button @click.stop="openSidebar(block.id)"
                                        class="p-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600 text-xs"
                                        title="Einstellungen öffnen">
                                        ⚙
                                    </button>
                                    <button @click.stop="moveBlock(index, 'up')" :disabled="index === 0"
                                        :class="index === 0 ? 'opacity-50 cursor-not-allowed' : ''"
                                        class="p-1 bg-white rounded shadow hover:bg-gray-100" title="Nach oben">
                                        ↑
                                    </button>
                                    <button @click.stop="moveBlock(index, 'down')"
                                        :disabled="index === blocks.length - 1"
                                        :class="index === blocks.length - 1 ? 'opacity-50 cursor-not-allowed' : ''"
                                        class="p-1 bg-white rounded shadow hover:bg-gray-100" title="Nach unten">
                                        ↓
                                    </button>
                                    <button @click.stop="deleteBlock(block.id)"
                                        class="p-1 bg-red-500 text-white rounded shadow hover:bg-red-600"
                                        title="Löschen">
                                        ×
                                    </button>
                                </div>

                                <!-- Block Content -->
                                <div class="block-content">
                                    <!-- Zentrale Rendering-Funktion für alle Block-Typen -->
                                    <div x-html="renderBlock(block)"></div>

                                </div>
                            </div>

                            <!-- Children Blocks (Verschachtelt) - für normale Container -->
                            <div x-show="block.children && block.children.length > 0 && block.type !== 'twoColumn' && block.type !== 'threeColumn' && block.type !== 'link'"
                                class="ml-8 mt-2 space-y-2 border-l-2 border-gray-300 pl-4">
                                <template x-for="(child, childIndex) in block.children" :key="child.id">
                                    <div :class="{
                                        'ring-2 ring-blue-500': selectedBlockId === child.id,
                                        'opacity-50': draggingBlockId === child.id,
                                        'drag-over': dragOverIndex && dragOverIndex.type === 'child' && dragOverIndex.parentIndex === index && dragOverIndex.childIndex === childIndex && (!dragStartIndex || dragStartIndex.childIndex !== childIndex)
                                    }" class="block-item group relative p-2 rounded-lg hover:bg-gray-50 transition-all cursor-move bg-gray-50"
                                        @click.stop="selectBlock(child.id)" draggable="true"
                                        @dragstart="handleDragStart($event, index, childIndex)"
                                        @dragover.prevent="handleDragOver($event, index, childIndex)"
                                        @drop="handleDrop($event, index, childIndex)" @dragend="handleDragEnd()">
                                        <!-- Visual Indicator für ausgewählten Child Block -->
                                        <div x-show="selectedBlockId === child.id"
                                            class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l"></div>

                                        <!-- Child Block Controls -->
                                        <div :class="selectedBlockId === child.id ? 'opacity-100' : ''"
                                            class="absolute -left-10 top-2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                            <button @click.stop="openSidebar(child.id)"
                                                class="p-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600 text-xs"
                                                title="Einstellungen öffnen">
                                                ⚙
                                            </button>
                                            <button @click.stop="moveChildBlock(block.id, childIndex, 'up')"
                                                :disabled="childIndex === 0"
                                                :class="childIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''"
                                                class="p-1 bg-white rounded shadow hover:bg-gray-100" title="Nach oben">
                                                ↑
                                            </button>
                                            <button @click.stop="moveChildBlock(block.id, childIndex, 'down')"
                                                :disabled="childIndex === (block.children.length - 1)"
                                                :class="childIndex === (block.children.length - 1) ? 'opacity-50 cursor-not-allowed' : ''"
                                                class="p-1 bg-white rounded shadow hover:bg-gray-100"
                                                title="Nach unten">
                                                ↓
                                            </button>
                                            <button @click.stop="removeChild(block.id, childIndex)"
                                                class="p-1 bg-red-500 text-white rounded shadow hover:bg-red-600"
                                                title="Löschen">
                                                ×
                                            </button>
                                        </div>

                                        <!-- Child Block Content -->
                                        <div class="block-content">
                                            <!-- Zentrale Rendering-Funktion für alle Child-Block-Typen -->
                                            <div x-html="renderChild(child, block, childIndex)"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Add Block Button -->
                    <div @click="showToolbar = true; showThemeDropdown = false"
                        class="mt-4 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-500 hover:border-blue-500 hover:text-blue-500 cursor-pointer transition-colors">
                        + Block hinzufügen
                    </div>
                </div>
            </div>

            <!-- JSON Display (for debugging) -->
            <div
                class="mt-8 bg-gray-900 text-green-400 p-4 pr-0 rounded-lg overflow-auto font-mono text-xs max-h-64 relative">
                <!-- Copy JSON to Clipboard Button -->
                <button @click="copyJSONToClipboard()"
                    class="absolute top-4 right-4 z-[10] p-3  text-slate-400  hover:text-green-400 transition-colors hover:shadow-xl"
                    title="Editor JSON in Zwischenablage kopieren">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                </button>
                <div class="overflow-auto ">
                    <pre x-text="getJSONDisplay()"></pre>
                </div>

            </div>
        </div>

        <!-- JSON Import Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showImportModal">
            <div x-html="templates?.modals?.jsonImport || ''"></div>
        </template>

        <!-- Save Theme Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showSaveThemeModal">
            <div x-html="templates?.modals?.themeSave || ''"></div>
        </template>

        <!-- Edit Theme Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showEditThemeModal">
            <div x-html="templates?.modals?.themeEdit || ''"></div>
        </template>

        <!-- Import Theme Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showImportThemeModal">
            <div x-html="templates?.modals?.themeImport || ''"></div>
        </template>

        <!-- JSON Export Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showExportModal">
            <div x-html="templates?.modals?.jsonExport || ''"></div>
        </template>

        <!-- Floating Toolbar für Text-Selektion (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showFloatingToolbar">
            <div x-html="templates?.floatingToolbar || ''"></div>
        </template>

        <!-- Einheitliches Link-Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showLinkModal">
            <div x-html="templates?.modals?.link || ''"></div>
        </template>

        <!-- Confirm Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showConfirmModal">
            <div x-html="templates?.modals?.confirm || ''"></div>
        </template>

        <!-- Image Settings Modal (aus Template) - Lazy Loading mit x-if -->
        <template x-if="showImageSettingsModal">
            <div x-html="templates?.modals?.imageSettings || ''"></div>
        </template>

    </div>
    </div>


</body>

</html>